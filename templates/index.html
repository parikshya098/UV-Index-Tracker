{% extends "base.html" %}

{% block content %}
<h2>UV Index Forecast</h2>

<div class="form-container">
    <form method="POST" id="location-form">
        <!-- City or ZIP Code Search -->
        <label for="location">Enter City or Zip Code:</label>
        <input type="text" id="location" name="location" placeholder="City / ZIP Code" required>

        <!-- Coordinate Inputs -->
        <label for="latitude">Latitude:</label>
        <input type="text" id="latitude" name="latitude" readonly>

        <label for="longitude">Longitude:</label>
        <input type="text" id="longitude" name="longitude" readonly>

        <!-- Date Range Inputs -->
        <label for="from_date">From Date:</label>
        <input type="date" id="from_date" name="from_date" required>

        <label for="to_date">To Date:</label>
        <input type="date" id="to_date" name="to_date" required>

        <button type="button" onclick="detectLocation()">Use My Current Location</button>
        <button type="submit">Submit</button>
    </form>
</div>

<!-- JavaScript to detect location and reverse geocode -->
<script>
    async function detectLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (position) => {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                
                // Populate the latitude and longitude fields
                document.getElementById('latitude').value = latitude;
                document.getElementById('longitude').value = longitude;

                // Perform reverse geocoding to get the city name
                try {
                    const response = await fetch(`/reverse-geocode?latitude=${latitude}&longitude=${longitude}`);
                    const data = await response.json();
                    
                    if (response.ok && data.city) {
                        // Populate the city name into the location field
                        document.getElementById('location').value = data.city;
                    } else {
                        alert("Could not find your city. Please enter it manually.");
                    }
                } catch (error) {
                    console.error("Error during reverse geocoding:", error);
                    alert("An error occurred while fetching your location.");
                }
            }, (error) => {
                alert("Failed to get your location. Please check your browser permissions.");
                console.error("Geolocation error:", error);
            });
        } else {
            alert("Geolocation is not supported by your browser.");
        }
    }
</script>
{% endblock %}
